---
interface Props {
  phone?: string; // Accepts formats with spaces/plus; will be sanitized
  message?: string; // Optional pre-filled message
}

const { phone = "+56 9 8228 9832", message = "Hola! Me interesa obtener m√°s informaci√≥n sobre sus servicios." } = Astro.props as Props;

// Sanitize to digits for wa.me
const sanitized = (phone || "").replace(/\D/g, "");
const encodedMessage = encodeURIComponent(message);
const waUrl = `https://wa.me/${sanitized}?text=${encodedMessage}`;
---

<a
  href={waUrl}
  target="_blank"
  rel="noopener noreferrer"
  aria-label="Chatear por WhatsApp"
  title="WhatsApp"
  class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 z-50 print:hidden whatsapp-float-btn"
  data-phone={sanitized}
  data-message={message}
>
  <span class="sr-only">Abrir chat de WhatsApp</span>
  <div class="relative">
    <div class="absolute inset-0 rounded-full bg-[#25D366] opacity-40 animate-ping pointer-events-none"></div>
    <div
      class="w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-[#25D366] hover:bg-[#22c35e] text-white shadow-lg shadow-green-500/30 flex items-center justify-center transition-transform duration-200 hover:scale-105 relative z-10"
    >
      <!-- WhatsApp official glyph (SVG) -->
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 32 32"
        class="w-8 h-8 sm:w-10 sm:h-10"
        aria-hidden="true"
        focusable="false"
      >
        <path fill="currentColor" d="M19.11 17.42c-.27-.14-1.6-.79-1.85-.88-.25-.09-.43-.14-.62.14-.19.27-.71.88-.87 1.06-.16.18-.32.2-.6.07-.27-.14-1.14-.42-2.17-1.35-.8-.71-1.34-1.59-1.5-1.86-.16-.27-.02-.42.12-.56.12-.12.27-.32.41-.48.14-.16.19-.27.29-.45.09-.18.05-.34-.02-.48-.07-.14-.62-1.49-.85-2.05-.22-.53-.45-.46-.62-.47-.16-.01-.34-.01-.52-.01s-.48.07-.73.34c-.25.27-.96.94-.96 2.3s.99 2.66 1.12 2.85c.14.18 1.95 2.98 4.73 4.18.66.28 1.18.45 1.59.57.67.21 1.28.18 1.76.11.54-.08 1.6-.65 1.83-1.28.23-.63.23-1.17.16-1.28-.07-.11-.25-.18-.52-.32z"/>
        <path fill="currentColor" d="M26.02 5.98A12.93 12.93 0 0 0 16 2.28C8.92 2.28 3.17 8.03 3.17 15.1c0 2.27.59 4.49 1.71 6.46L3 29l7.6-1.98a12.84 12.84 0 0 0 5.4 1.21h.01c7.07 0 12.82-5.75 12.82-12.82 0-3.39-1.32-6.58-3.81-8.93zM16 26.45h-.01c-1.66 0-3.28-.43-4.72-1.24l-.34-.19-4.51 1.17 1.2-4.4-.22-.36a10.77 10.77 0 0 1-1.65-5.53c0-5.95 4.84-10.79 10.8-10.79 2.89 0 5.6 1.13 7.64 3.17a10.73 10.73 0 0 1 3.16 7.63c0 5.95-4.84 10.78-10.8 10.78z"/>
      </svg>
    </div>
  </div>
</a>

<script>
  // WhatsApp detection and fallback logic
  function initWhatsAppFloat() {
    const whatsappBtn = document.querySelector('.whatsapp-float-btn');
    if (!whatsappBtn) return;

    const phone = (whatsappBtn as HTMLElement).dataset.phone;
    const message = (whatsappBtn as HTMLElement).dataset.message;
    
    whatsappBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (isMobile) {
        // Try different WhatsApp schemes for mobile
        tryOpenWhatsApp(phone, message);
      } else {
        // For desktop, use wa.me directly
        const waUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message || '')}`;
        window.open(waUrl, '_blank', 'noopener,noreferrer');
      }
    });
  }

  function tryOpenWhatsApp(phone, message) {
    const encodedMessage = encodeURIComponent(message || '');
    
    // List of WhatsApp URL schemes to try in order
    const schemes = [
      `whatsapp://send?phone=${phone}&text=${encodedMessage}`, // Standard WhatsApp
      `https://wa.me/${phone}?text=${encodedMessage}`, // Web fallback
      `https://api.whatsapp.com/send?phone=${phone}&text=${encodedMessage}` // Alternative web
    ];
    
    let currentScheme = 0;
    
    function attemptOpen() {
      if (currentScheme >= schemes.length) {
        // All schemes failed, show user-friendly message
        showWhatsAppNotFoundMessage();
        return;
      }
      
      const url = schemes[currentScheme];
      const startTime = Date.now();
      
      // Create a hidden iframe to test the scheme
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = url;
      document.body.appendChild(iframe);
      
      // Set a timeout to check if the app opened
      setTimeout(() => {
        const elapsed = Date.now() - startTime;
        document.body.removeChild(iframe);
        
        // If we're still here after a short time, the app likely didn't open
        if (elapsed < 2000 && document.hasFocus()) {
          currentScheme++;
          attemptOpen();
        }
      }, 1000);
      
      // Also try opening directly for immediate response
      if (currentScheme === 0) {
        // For the first attempt, also try direct navigation
        window.location.href = url;
      } else {
        // For fallbacks, use window.open
        window.open(url, '_blank', 'noopener,noreferrer');
      }
    }
    
    attemptOpen();
  }
  
  function showWhatsAppNotFoundMessage() {
    // Create a temporary notification
    const notification = document.createElement('div');
    notification.innerHTML = `
      <div style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        border: 2px solid #25D366;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 300px;
        text-align: center;
        font-family: system-ui, -apple-system, sans-serif;
      ">
        <div style="color: #25D366; font-size: 24px; margin-bottom: 10px;">üì±</div>
        <h3 style="margin: 0 0 10px 0; color: #333;">WhatsApp no encontrado</h3>
        <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">
          Para contactarnos por WhatsApp, instala la aplicaci√≥n o usa el n√∫mero: <strong>+56 9 8228 9832</strong>
        </p>
        <button onclick="this.parentElement.parentElement.remove()" style="
          background: #25D366;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
        ">Cerrar</button>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
      }
    }, 5000);
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWhatsAppFloat);
  } else {
    initWhatsAppFloat();
  }
</script>

